## 📆 2025-11-28

### 🔔 스크럼

- 개인 프로젝트 서버 아키텍처 구성 마무리
- AWS ALB + HTTPS 인증서 적용
- 그에 맞게 프론트/백엔드 CI/CD 파이프라인 수정

### 🚀 Today I Learned

#### ALB는 HTTPS를 백엔드까지 전달하지 않는다 (TLS Termination)

- 클라이언트 → HTTPS → ALB에서 SSL 복호화
- ALB → HTTP로 대상 그룹(EC2 컨테이너)에 전달
- 백엔드는 8080에서 반드시 HTTP로만 받아야 한다s.
- 만약 HTTPS 패킷을 그대로 BE로 보내면 Tomcat이 해석하지 못해 에러가 난다.

#### ALB 리스너 규칙은 HTTP/HTTPS 모두 동일해야 한다

- /api/\*\* → backend(8080)
- / → frontend(3000)
- HTTPS 리스너도 위 규칙을 그대로 따라야 안정적으로 동작한다.

#### Target Group의 프로토콜은 HTTP여야 한다

- EC2 내부 컨테이너는 HTTPS 처리 불가
- Target Group이 HTTPS로 설정되면 502/Gateway Error 발생

#### 운영 환경 쿠키 설정 조건

- 운영 HTTPS에서는 반드시 다음 조합을 만족해야 한다:
- secure=true
- sameSite=None
- domain=YOUR_DOMIN
- 쿠키가 설정되지 않거나, 백엔드 요청이 인증되지 않을 때 이 부분이 핵심이다.

#### CI/CD 자동 배포의 흐름 이해

- 기존에는 단일 EC2에 배포하여 docker-compose 하나였는데, 다중 EC2로 바꾸면서 아래 절차를 각각 수행하여 프론트·백엔드 각각 독립된 파이프라인 구성할 수 있었다.
- GitHub Actions → Docker build → Docker Hub push → EC2 pull → docker compose 재시작

### 🔥 오늘의 도전 과제와 해결 방법

- FE/BE 도커는 정상 실행되는데 화면이 열리지 않는 문제

  - 문제 : EC2를 프론트/백엔드 2개로 분리한 후 각 서버에서 docker-compose up 했는데 컨테이너는 뜨지만 서비스가 열리지 않음.
  - 원인 : 기존에는 하나의 docker-compose에서 컨테이너끼리 내부 네트워크로 붙어 있었고 포트를 외부에 노출할 필요가 없었음. 하지만 EC2를 분리한 후 각각 3000 / 8080 포트 매핑이 필요했는데 누락됨.
  - 해결 방법 : 각 docker-compose에 포트 추가하여 해결함

- ALB DNS로 접속하면 되는데, 도메인으로 접속하면 502 나는 문제 - 원인 : ALB 헬스체크 기본 포트가 80인데 실제 앱은 3000, 8080에서 동작 중. 헬스체크가 80으로 감 → 응답 없음 → 인스턴스를 "죽었다고 판단"
  → 도메인 요청을 대상 그룹으로 전달하지 않음 → 502 발생 - 해결 바업 : 헬스체크가 살아야 도메인이 정상적으로 트래픽을 보내기 때문에 각 대상 그룹의 상태 검사 포트를 실제 서비스 포트로 변경

- HTTPS에서 프론트는 열리는데 백엔드 API만 502 발생

  - 원인 : BE 대상 그룹의 프로토콜이 HTTPS로 잡혀 있었음. 이 경우 HTTPS 패킷이 그대로 백엔드(tomcat)로 전달되어 Tomcat이 패킷을 파싱하지 못함
  - 해결 방법 : HTTP/HTTPS 두 리스너 모두 다음처럼 정렬
    - /api/\* → backend(HTTP 8080)
    - / → frontend(HTTP 3000)
    - 즉, HTTP/HTTPS 모두 같은 대상 그룹 + 같은 규칙을 가지도록 수정하니 정상 동작

- RDS 연결 오류: Public Key Retrieval is not allowed

  - 원인 : MySQL 8.x에서는 caching_sha2_password 인증 방식을 기본으로 사용하는데, 비밀번호 로그인 시 public key를 받을 권한이 없으면 연결이 막힘. 또한 .env.prod에 저장된 DB_USER / DB_PASSWORD가 잘못되어 있어서 제대로 인증이 되지 않았음
  - 해결 방법 : application.yml의 datasource URL에 다음 옵션을 추가하고 .env.prod에 DB 계정 정보를 RDS 엔드포인트로 수정

- 백엔드 API 호출 시 CORS·쿠키 문제로 403 발생
  - 원인 : HTTPS 환경에서 SameSite 기본값 Lax로 인해 쿠키가 cross-site 환경에서 전송되지 않음, domain 미설정으로 쿠키가 제대로 브라우저에 저장되지 않음
  - 해결 방법 : 쿠키 설정을 운영 기준으로 변경

### 🗨️ 오늘의 회고

- 단일 EC2에 모든 서비스를 올려두고 사용하던 구조에서 벗어나, ALB + 다중 EC2 + RDS 기반의 아키텍처로 확장하고 Docker로 배포하는 과정은 확실히 쉽지 않았다.
- 또한, 개념적으로는 “ALB가 SSL을 해제(terminate)하고 뒤쪽 인스턴스에는 HTTP로 전달한다”는 사실을 알고 있었는데, 막상 실제로 오류가 터지니까 그 부분이 바로 떠오르지 않아서 의도치 않은 삽질을 꽤 많이 하게 되었다. 그래도 이번에 제대로 몸으로 겪고 나니, 앞으로는 절대 잊지 않을 것 같다.
- 이번 주 과제가 FE/BE 각각에 CI/CD를 적용해보는 거였는데, 처음에는 단일 EC2에서 먼저 CI/CD를 적용해보고, 그 다음 오늘 만든 **멀티 인프라 구조(프론트 EC2 + 백엔드 EC2 + RDS + ALB)**에도 적용해보면서 단계적으로 이해가 더 깊어졌다.
- 아직 개선할 부분도 많고, 더 발전시킬 수 있는 아키텍처도 많지만, 이번 경험을 기반으로 앞으로 인프라 구조를 더 디벨롭해보고 싶다는 생각이 들었다.
